<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Jobs</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7f6; max-width: 1000px; margin: 0 auto; padding: 2rem; color: #333; }
        header { text-align: center; margin-bottom: 2rem; }
        h1 { color: #005596; margin-bottom: 0.5rem; }
        .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .last-scraped-header { font-size: 0.85rem; color: #888; margin-bottom: 1.5rem; font-style: italic; }
        
        .stats-bar { font-size: 0.9rem; color: #666; margin-bottom: 1rem; font-weight: 600; }
        .controls { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        .search-row { display: flex; gap: 10px; margin-bottom: 1rem; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .btn-refresh { background: #005596; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .filter-section { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .filter-label { font-size: 0.8rem; font-weight: bold; color: #555; margin-bottom: 8px; display: block; text-transform: uppercase; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { font-size: 0.7rem; background: #f0f0f0; padding: 5px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #ddd; transition: 0.2s; font-weight: 500; }
        .chip.active { background: #005596; color: white; border-color: #005596; }

        #app { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .job-card { background: white; padding: 1.5rem; border-radius: 6px; border: 1px solid #eee; text-decoration: none; color: inherit; display: block; transition: 0.2s; }
        .job-card:hover { border-color: #005596; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .job-title { font-weight: bold; color: #005596; margin-bottom: 6px; font-size: 1.15rem; }
        .job-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-bottom: 12px; }
        .job-category { display: inline-block; background: #e1e8ed; color: #005596; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    </style>
</head>
<body>

    <header>
        <h1>UC Jobs</h1>
        <div id="lastUpdatedHeader" class="last-scraped-header">Loading timestamp...</div>
    </header>

    <div class="stats-bar">
        Showing <span id="currentCount">0</span> of <span id="totalCount">0</span> total jobs
    </div>

    <div class="controls">
        <div class="search-row">
            <div style="position: relative; flex: 1; display: flex;">
                <input type="text" id="searchInput" placeholder="Search title, keyword, or city..." oninput="handleSearchInput()">
                <span id="clearSearch" onclick="clearSearchInput()" style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-weight: bold; font-size: 1.2rem;">&times;</span>
            </div>
        </div>
        
        <div class="filter-section">
            <span class="filter-label">Filter by Location:</span>
            <div id="locationChips" class="chip-container"></div>
        </div>

        <div class="filter-section">
            <span class="filter-label">Filter by Category:</span>
            <div id="categoryChips" class="chip-container"></div>
        </div>
    </div>

    <main id="app"></main>

    <script>
        let allJobs = [];
        let selectedLocations = new Set();
        let selectedCategories = new Set();

        function getTimeAgo(dateString) {
            const diff = new Date() - new Date(dateString);
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return "just now";
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            return new Date(dateString).toLocaleDateString();
        }

        async function loadJobs() {
            const app = document.getElementById('app');
            app.innerHTML = '<div style="text-align:center">Loading data...</div>';
            try {
                const res = await fetch('jobs.json?v=' + Date.now());
                const data = await res.json();
                allJobs = data.results || [];
                
                document.getElementById('totalCount').textContent = allJobs.length;
                document.getElementById('lastUpdatedHeader').textContent = `Scraper last ran: ${getTimeAgo(data.updated_at)} (${new Date(data.updated_at).toLocaleString()})`;
                
                generateChips('locationChips', 'location', selectedLocations);
                generateChips('categoryChips', 'category', selectedCategories);
                filterJobs();
            } catch (e) { app.innerHTML = 'Error loading data.'; }
        }

        function generateChips(containerId, field, selectionSet) {
            const container = document.getElementById(containerId);
            const items = [...new Set(allJobs.map(j => j[field] || 'N/A'))].sort();
            
            container.innerHTML = items.map(item => `
                <div class="chip ${selectionSet.has(item) ? 'active' : ''}" 
                     onclick="toggleChip('${item}', '${containerId}', this)">${item}</div>
            `).join('');
        }

        function toggleChip(value, containerId, el) {
            const selectionSet = containerId === 'locationChips' ? selectedLocations : selectedCategories;
            if (selectionSet.has(value)) {
                selectionSet.delete(value);
                el.classList.remove('active');
            } else {
                selectionSet.add(value);
                el.classList.add('active');
            }
            filterJobs();
        }

        // Function to show/hide the X based on text input
        function handleSearchInput() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            
            clearBtn.style.display = input.value.length > 0 ? 'block' : 'none';
            filterJobs();
        }
        
        // Function to clear the input and reset the list
        function clearSearchInput() {
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('clearSearch').style.display = 'none';
            filterJobs(); // Refresh the list to show all results
        }

        function filterJobs() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const app = document.getElementById('app');

            const filtered = allJobs.filter(j => {
                const matchesSearch = `${j.title} ${j.location} ${j.category || ''}`.toLowerCase().includes(query);
                const matchesLocation = selectedLocations.size === 0 || selectedLocations.has(j.location);
                const matchesCategory = selectedCategories.size === 0 || selectedCategories.has(j.category || 'N/A');
                return matchesSearch && matchesLocation && matchesCategory;
            });

            document.getElementById('currentCount').textContent = filtered.length;
            app.innerHTML = filtered.map(j => `
                <a href="${j.url}" target="_blank" class="job-card">
                    <div class="job-title">${j.title}</div>
                    <div class="job-meta"><span>üìç ${j.location}</span><span>üìÖ ${j.date}</span></div>
                    <div class="job-category">${j.category || 'N/A'}</div>
                </a>
            `).join('');
        }

        loadJobs();
    </script>
</body>
</html>
