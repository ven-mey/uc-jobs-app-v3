<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Jobs</title> <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7f6; max-width: 1000px; margin: 0 auto; padding: 2rem; color: #333; }
        header { text-align: center; margin-bottom: 1rem; }
        h1 { color: #005596; margin-bottom: 5px; } /* Updated Heading */
        .last-scraped-header { font-size: 0.85rem; color: #888; margin-bottom: 1.5rem; font-style: italic; }
        
        .stats-bar { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #666; margin-bottom: 1rem; font-weight: 600; }
        
        /* Collapsible Filter Area */
        .controls-wrapper { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; overflow: hidden; }
        .filter-header { background: #f8f9fa; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .filter-content { padding: 20px; display: block; }
        .filter-content.hidden { display: none; }

        .search-row { display: flex; gap: 10px; margin-bottom: 1.5rem; }
        .input-container { position: relative; flex: 1; }
        input[type="text"] { width: 100%; padding: 12px 40px 12px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        #clearSearch { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #ccc; display: none; font-size: 1.5rem; line-height: 1; }

        /* Filter Chips */
        .filter-section { margin-bottom: 15px; }
        .filter-label { font-size: 0.75rem; font-weight: bold; color: #777; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip { font-size: 0.7rem; background: #f0f0f0; padding: 6px 14px; border-radius: 20px; cursor: pointer; border: 1px solid #ddd; white-space: nowrap; transition: 0.2s; }
        .chip.active { background: #005596; color: white; border-color: #005596; }
        .chip.special { border: 1px dashed #005596; color: #005596; font-weight: bold; }
        .chip.special.active { background: #005596; color: white; border-style: solid; }

        /* Job Cards */
        .job-card { background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #eee; text-decoration: none; color: inherit; display: block; position: relative; margin-bottom: 12px; transition: 0.2s; }
        .job-card:hover { border-color: #005596; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .job-title { font-weight: bold; color: #005596; font-size: 1.15rem; padding-right: 45px; line-height: 1.3; }
        
        /* Badges & Favorite Icon */
        .favorite-btn { position: absolute; top: 1.5rem; right: 1.5rem; font-size: 1.6rem; cursor: pointer; color: #eee; transition: 0.2s; z-index: 10; user-select: none; }
        .favorite-btn.active { color: #f1c40f; }
        .new-badge { background: #27ae60; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; margin-left: 8px; vertical-align: middle; }
        
        .btn-reset { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>UC Jobs</h1> <div id="lastUpdatedHeader" class="last-scraped-header">Loading...</div>
    </header>

    <div class="stats-bar">
        <div>Showing <span id="currentCount">0</span> of <span id="totalCount">0</span> jobs</div>
        <button class="btn-reset" onclick="resetAllFilters()">Clear All Filters</button> </div>

    <div class="controls-wrapper">
        <div class="filter-header" onclick="toggleFilters()"> <strong>Search & Filters</strong>
            <span id="toggleIcon">‚ñº</span>
        </div>
        <div id="filterContent" class="filter-content">
            <div class="search-row">
                <div class="input-container">
                    <input type="text" id="searchInput" placeholder="Search keywords..." oninput="handleSearch()">
                    <span id="clearSearch" onclick="clearSearchInput()">&times;</span> </div>
            </div>

            <div class="filter-section">
                <span class="filter-label">Quick Views</span>
                <div class="chip-container">
                    <div id="filterFavs" class="chip special" onclick="toggleSpecialFilter('favs')">‚òÖ Favorites</div> <div id="filterNew" class="chip special" onclick="toggleSpecialFilter('new')">‚ú® New Since Last Visit</div> </div>
            </div>

            <div class="filter-section">
                <span class="filter-label">Locations</span>
                <div id="locationChips" class="chip-container"></div>
            </div>

            <div class="filter-section">
                <span class="filter-label">Categories</span>
                <div id="categoryChips" class="chip-container"></div>
            </div>
        </div>
    </div>

    <main id="app"></main>

    <script>
        let allJobs = [];
        let selectedLocations = new Set();
        let selectedCategories = new Set();
        let showOnlyFavs = false;
        let showOnlyNew = false;
        
        // Favorite and Visit logic using LocalStorage
        let favorites = new Set(JSON.parse(localStorage.getItem('uc_favorites') || '[]'));
        let lastVisit = parseInt(localStorage.getItem('uc_last_visit') || Date.now());

        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('toggleIcon');
            content.classList.toggle('hidden');
            icon.textContent = content.classList.contains('hidden') ? '‚ñ≤' : '‚ñº';
        }

        async function loadJobs() {
            try {
                const res = await fetch('jobs.json?v=' + Date.now());
                const data = await res.json();
                allJobs = data.results || [];
                
                document.getElementById('totalCount').textContent = allJobs.length;
                document.getElementById('lastUpdatedHeader').textContent = `Checked: ${new Date(data.updated_at).toLocaleString()}`;
                
                generateChips('locationChips', 'location', selectedLocations);
                generateChips('categoryChips', 'category', selectedCategories);
                
                filterJobs();
                
                // Track visit time
                localStorage.setItem('uc_last_visit', Date.now().toString());
            } catch (e) { console.error(e); }
        }

        function generateChips(containerId, field, selectionSet) {
            const container = document.getElementById(containerId);
            const items = [...new Set(allJobs.map(j => j[field] || 'N/A'))].sort();
            container.innerHTML = items.map(item => `
                <div class="chip ${selectionSet.has(item) ? 'active' : ''}" 
                     onclick="toggleChip('${item}', '${containerId}', this)">${item}</div>
            `).join('');
        }

        function toggleChip(value, containerId, el) {
            const set = containerId === 'locationChips' ? selectedLocations : selectedCategories;
            set.has(value) ? set.delete(value) : set.add(value);
            el.classList.toggle('active');
            filterJobs();
        }

        function toggleSpecialFilter(type) {
            if (type === 'favs') {
                showOnlyFavs = !showOnlyFavs;
                document.getElementById('filterFavs').classList.toggle('active');
            } else {
                showOnlyNew = !showOnlyNew;
                document.getElementById('filterNew').classList.toggle('active');
            }
            filterJobs();
        }

        function toggleFavorite(url, event) {
            event.preventDefault(); // Mark Favorite
            favorites.has(url) ? favorites.delete(url) : favorites.add(url);
            localStorage.setItem('uc_favorites', JSON.stringify([...favorites]));
            filterJobs();
        }

        function resetAllFilters() {
            selectedLocations.clear();
            selectedCategories.clear();
            showOnlyFavs = false;
            showOnlyNew = false;
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            filterJobs();
        }

        function handleSearch() {
            const val = document.getElementById('searchInput').value;
            document.getElementById('clearSearch').style.display = val ? 'block' : 'none';
            filterJobs();
        }

        function clearSearchInput() {
            document.getElementById('searchInput').value = '';
            handleSearch();
        }

        function filterJobs() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allJobs.filter(j => {
                const searchable = `${j.title} ${j.location} ${j.category || ''}`.toLowerCase();
                const matchesSearch = searchable.includes(query);
                const matchesLoc = selectedLocations.size === 0 || selectedLocations.has(j.location);
                const matchesCat = selectedCategories.size === 0 || selectedCategories.has(j.category || 'N/A');
                const matchesFav = !showOnlyFavs || favorites.has(j.url);
                const jobTime = j.scraped_at ? new Date(j.scraped_at).getTime() : 0;
                const matchesNew = !showOnlyNew || jobTime > lastVisit; // Filter new since visit

                return matchesSearch && matchesLoc && matchesCat && matchesFav && matchesNew;
            });

            document.getElementById('currentCount').textContent = filtered.length;
            renderJobs(filtered);
        }

        function renderJobs(jobs) {
            const app = document.getElementById('app');
            app.innerHTML = jobs.map(j => {
                const isFav = favorites.has(j.url);
                const jobTime = j.scraped_at ? new Date(j.scraped_at).getTime() : 0;
                const isNew = jobTime > lastVisit; // Indicate new jobs

                return `
                <div class="job-card">
                    <span class="favorite-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${j.url}', event)">‚òÖ</span>
                    <a href="${j.url}" target="_blank" style="text-decoration:none; color:inherit;">
                        <div class="job-title">${j.title} ${isNew ? '<span class="new-badge">NEW</span>' : ''}</div>
                        <div class="job-meta">
                            <span>üìç ${j.location}</span>
                            <span>üìÖ ${j.date}</span>
                        </div>
                        <div class="job-category">${j.category || 'N/A'}</div>
                    </a>
                </div>`;
            }).join('');
        }

        loadJobs();
    </script>
</body>
</html>
